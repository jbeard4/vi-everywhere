<scxml 
	xmlns="http://www.w3.org/2005/07/scxml" 
	xmlns:vi="urn:vi"
	profile="ecmascript" 
	version="1.0" 
	name="viBehaviour" 
	initial="initial_default">

	<datamodel>
		<data id="controller"/>
	</datamodel>

	<state id="initial_default">
		<transition event="init" target="normal_mode">
			<assign location="controller" expr="_event.data"/>	
		</transition>
	</state>

	<state id="normal_mode">

		<onentry>
			<script>
				controller.makeCursorFat();
				controller.updateModeText("-- NORMAL --")
			</script>
		</onentry>

		<vi:macro name="printable_keys_used_to_move_cursor">
			<vi:param name="updateSelection" value="false"/>
		</vi:macro>

		<vi:macro name="nonprintable_keys_used_to_move_cursor">
			<vi:param name="updateSelection" value="true"/>
		</vi:macro>
			
		<transition event="v_keypress" target="visual_character"/>
		<transition event="V_keypress" target="visual_line"/>
		<transition event="ctrl_v_keypress" target="visual_block"/>

		<!--
		<transition event="G" target="normal_mode">
			<script>	
				controller.moveToLastLineOfDocument()
			</script>
		</transition>

		<transition event="g" target="after_g"/>

		<state id="after_g">
			<script>
				controller.moveToFirstLineOfDocument()
			</script>
		</state>
		-->

		<transition event="i_keypress" target="insert_mode"/>

		<transition event="a_keypress" target="insert_mode">
			<script>
				controller.moveRight(true);
			</script>
		</transition>

	</state>

	<state id="visual_or_select_mode" initial="visual_mode">

		<onentry>
			<script>
				controller.makeCursorFat();
				controller.startSelection(); 
			</script>
		</onentry>

		<onexit>
			<script>
				controller.clearSelection(); 
			</script>
		</onexit>

		<vi:macro name="nonprintable_keys_used_to_move_cursor">
			<vi:param name="updateSelection" value="true"/>
		</vi:macro>

		<transition event="esc_keypress" target="normal_mode"/>

		<state id="select_mode" initial="select_character">

			<transition event="*" target="normal_mode"
				cond="_event.data.charCode !== 0">
				<script>
					//TODO: delete text in selection, replace with event data
					var c = String.fromCharCode(_event.data.charCode);
					alert("replaced text with " + c);
				</script>
			</transition>

			<state id="select_line">
				<onentry>
					<script>
						controller.updateModeText("-- SELECT LINE --")
						controller.setSelectionMode(controller.SELECTION_MODE.LINE);
					</script>
				</onentry>
				<transition event="ctrl_v_keypress" target="select_block"/>
				<transition event="v_keypress" target="select_character"/>

				<transition event="ctrl_g_keypress" target="visual_line" />
			</state>

			<state id="select_block">
				<onentry>
					<script>
						controller.updateModeText("-- SELECT BLOCK --")
						controller.setSelectionMode(controller.SELECTION_MODE.BLOCK);
					</script>
				</onentry>
				<transition event="v_keypress" target="select_character"/>
				<transition event="V_keypress" target="select_line"/>

				<transition event="ctrl_g_keypress" target="visual_block" />
			</state>

			<state id="select_character">
				<onentry>
					<script>
						controller.updateModeText("-- SELECT --")
						controller.setSelectionMode(controller.SELECTION_MODE.CHARACTER);
					</script>
				</onentry>
				<transition event="ctrl_v_keypress" target="select_block"/>
				<transition event="V_keypress" target="select_line"/>

				<transition event="ctrl_g_keypress" target="visual_character" />
			</state>
		</state>

		<state id="visual_mode" initial="visual_character">
			<!-- these will be the same in both visual and select -->

			<!-- FIXME: this should be yy -->
			<transition event="y_keypress" target="normal_mode">
				<script>
					controller.copySelectedTextIntoRegister();  
				</script>
			</transition>

			<transition event="x_keypress" target="normal_mode">
				<script>
					controller.deleteSelectedTextIntoRegister();  
				</script>
			</transition>

			<transition event="d_keypress" target="normal_mode">
				<script>
					controller.deleteSelectedTextIntoRegister();  
				</script>
			</transition>

			<transition event="c_keypress" target="insert_mode">
				<script>
					controller.deleteSelectedTextIntoRegister();  
				</script>
			</transition>

			<vi:macro name="printable_keys_used_to_move_cursor">
				<vi:param name="updateSelection" value="true"/>
			</vi:macro>


			<!-- TODO: figure out what kind of API we want for selection stuff -->
			<state id="visual_line">
				<onentry>
					<script>
						controller.updateModeText("-- VISUAL LINE --")
						controller.setSelectionMode(controller.SELECTION_MODE.LINE);
					</script>
				</onentry>
				<transition event="ctrl_v_keypress" target="visual_block"/>
				<transition event="v_keypress" target="visual_character"/>

				<transition event="ctrl_g_keypress" target="select_line" />
			</state>

			<state id="visual_block">
				<onentry>
					<script>
						controller.updateModeText("-- VISUAL BLOCK --")
						controller.setSelectionMode(controller.SELECTION_MODE.BLOCK);
					</script>
				</onentry>
				<transition event="v_keypress" target="visual_character"/>
				<transition event="V_keypress" target="visual_line"/>

				<transition event="ctrl_g_keypress" target="select_block" />
			</state>

			<state id="visual_character">
				<onentry>
					<script>
						controller.updateModeText("-- VISUAL --")
						controller.setSelectionMode(controller.SELECTION_MODE.CHARACTER);
					</script>
				</onentry>
				<transition event="ctrl_v_keypress" target="visual_block"/>
				<transition event="V_keypress" target="visual_line"/>

				<transition event="ctrl_g_keypress" target="select_character" />
			</state>

		</state>
	</state>


	<state id="insert_mode">
		<onentry>
			<script>
				controller.makeCursorThin()
				controller.updateModeText("-- INSERT --")
			</script>
		</onentry>

		<vi:macro name="nonprintable_keys_used_to_move_cursor">
			<vi:param name="updateSelection" value="true"/>
		</vi:macro>

		<transition event="esc_keypress" target="normal_mode">
			<script>
				controller.moveLeft()
			</script>
		</transition>

		<transition event="enter_keypress">
			<script>
				controller.writeNewLine()
			</script>
		</transition>

		<transition event="backspace_keypress">
			<script>
				controller.writeBackspace()
			</script>
		</transition>


		<!-- everything else -->
		<transition event="*">
			<script>
				controller.writeChar(_event.data.charCode)
			</script>
		</transition>
	</state>


	<state id="command_mode">
		<onentry>
			<script>
				controller.updateModeText("-- COMMAND --")
			</script>
		</onentry>

		<!-- printable characters: add to command buffer -->
		<!-- newline: run command -->
		
		<transition event="esc_keypress" target="normal_mode"/>
	</state>

	
</scxml>

